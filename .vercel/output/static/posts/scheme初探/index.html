<!DOCTYPE html><html lang=en><head><meta charset=UTF-8><meta content="width=device-width" name=viewport><link href=/favicon.ico rel=icon type=image/svg+xml><link href=https://mliu.me/posts/scheme%E5%88%9D%E6%8E%A2/ rel=canonical><meta content="Astro v2.10.15" name=generator><title>Scheme初探</title><meta content=Scheme初探 name=title><meta content=scheme简洁优雅强大，直指编程本质。学之能去芜存精，助我们提升编程水平。 name=description><meta content="Martin Liu" name=author><link href=/sitemap-index.xml rel=sitemap><meta content=Scheme初探 property=og:title><meta content=scheme简洁优雅强大，直指编程本质。学之能去芜存精，助我们提升编程水平。 property=og:description><meta content=https://mliu.me/posts/scheme%E5%88%9D%E6%8E%A2/ property=og:url><meta content=https://mliu.me/Scheme%E5%88%9D%E6%8E%A2.png property=og:image><meta content=summary_large_image property=twitter:card><meta content=https://mliu.me/posts/scheme%E5%88%9D%E6%8E%A2/ property=twitter:url><meta content=Scheme初探 property=twitter:title><meta content=scheme简洁优雅强大，直指编程本质。学之能去芜存精，助我们提升编程水平。 property=twitter:description><meta content=https://mliu.me/Scheme%E5%88%9D%E6%8E%A2.png property=twitter:image><link href=https://fonts.googleapis.com rel=preconnect><link href=https://fonts.gstatic.com rel=preconnect crossorigin><link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:ital,wght@0,400;0,500;0,600;0,700;1,400;1,600&display=swap" rel=stylesheet><script src=/toggle-theme.js></script><link href=/_astro/about.749ae34c.css rel=stylesheet /><link href=/_astro/about.6e6daff0.css rel=stylesheet /><link href=/_astro/_slug_.40cf44c5.css rel=stylesheet /><link href=/_astro/_slug_.41a32359.css rel=stylesheet /><link href=/_astro/_slug_.3b14054e.css rel=stylesheet /><link href=/_astro/_slug_.906d67ca.css rel=stylesheet /><script type=module>const e=document.querySelector(".hamburger-menu"),n=document.querySelector(".menu-icon"),u=document.querySelector("#menu-items");e?.addEventListener("click",(()=>{const t="true"===e.getAttribute("aria-expanded");n?.classList.toggle("is-active"),e.setAttribute("aria-expanded",t?"false":"true"),e.setAttribute("aria-label",t?"Open Menu":"Close Menu"),u?.classList.toggle("display-none")}))</script><script src=/_astro/page.7d71c7ef.js type=module></script></head><body><header class=astro-3EF6KSR2><a href=#main-content class=astro-3EF6KSR2 id=skip-to-content>Skip to content</a><div class="astro-3EF6KSR2 nav-container"><div class="astro-3EF6KSR2 top-nav-wrap"><a href=/ class="astro-3EF6KSR2 logo">Martin Liu</a><nav class=astro-3EF6KSR2 id=nav-menu><button class="astro-3EF6KSR2 focus-outline hamburger-menu" aria-label="Open Menu" aria-controls=menu-items aria-expanded=false><svg class="astro-3EF6KSR2 menu-icon" xmlns=http://www.w3.org/2000/svg stroke-linecap=round stroke-linejoin=round fill=none height=24 stroke=currentColor stroke-width=1.5 viewBox="0 0 24 24" width=24><line x1=7 x2=21 y1=12 y2=12 class="line astro-3EF6KSR2"></line><line x1=3 x2=21 y1=6 y2=6 class="line astro-3EF6KSR2"></line><line x1=12 x2=21 y1=18 y2=18 class="line astro-3EF6KSR2"></line><line x1=18 x2=6 y1=6 y2=18 class="astro-3EF6KSR2 close"></line><line x1=6 x2=18 y1=6 y2=18 class="astro-3EF6KSR2 close"></line></svg></button><ul class="astro-3EF6KSR2 display-none sm:flex" id=menu-items><li class=astro-3EF6KSR2><a href=/posts class=astro-3EF6KSR2>Posts</a></li><li class=astro-3EF6KSR2><a href=/tags class=astro-3EF6KSR2>Tags</a></li><li class=astro-3EF6KSR2><a href=/about class=astro-3EF6KSR2>About</a></li><li class=astro-3EF6KSR2><a href=/search class="astro-3EF6KSR2 focus-outline astro-5EUNQZKT group inline-block p-3 sm:p-1" title=Search tabindex=0 aria-label=search><svg class="astro-3EF6KSR2 scale-125 sm:scale-100" xmlns=http://www.w3.org/2000/svg><path d="M19.023 16.977a35.13 35.13 0 0 1-1.367-1.384c-.372-.378-.596-.653-.596-.653l-2.8-1.337A6.962 6.962 0 0 0 16 9c0-3.859-3.14-7-7-7S2 5.141 2 9s3.14 7 7 7c1.763 0 3.37-.66 4.603-1.739l1.337 2.8s.275.224.653.596c.387.363.896.854 1.384 1.367l1.358 1.392.604.646 2.121-2.121-.646-.604c-.379-.372-.885-.866-1.391-1.36zM9 14c-2.757 0-5-2.243-5-5s2.243-5 5-5 5 2.243 5 5-2.243 5-5 5z" class=astro-3EF6KSR2></path></svg></a></li><li class=astro-3EF6KSR2><a href=/rss.xml class="astro-3EF6KSR2 rss-link" title="RSS Feed" aria-label="rss feed" target=_blank><svg class="astro-3EF6KSR2 icon icon-tabler icon-tabler-rss" xmlns=http://www.w3.org/2000/svg stroke-linecap=round stroke-linejoin=round fill=none height=24 stroke=currentColor stroke-width=2 viewBox="0 0 27 27" width=24><path d="M0 0h24v24H0z" class=astro-3EF6KSR2 fill=none stroke=none></path><path d="M5 19m-1 0a1 1 0 1 0 2 0a1 1 0 1 0 -2 0" class=astro-3EF6KSR2></path><path d="M4 4a16 16 0 0 1 16 16" class=astro-3EF6KSR2></path><path d="M4 11a9 9 0 0 1 9 9" class=astro-3EF6KSR2></path></svg></a></li><li class=astro-3EF6KSR2><button class="astro-3EF6KSR2 focus-outline" aria-label=auto aria-live=polite id=theme-btn title="Toggles light & dark"><svg class=astro-3EF6KSR2 xmlns=http://www.w3.org/2000/svg id=moon-svg><path d="M20.742 13.045a8.088 8.088 0 0 1-2.077.271c-2.135 0-4.14-.83-5.646-2.336a8.025 8.025 0 0 1-2.064-7.723A1 1 0 0 0 9.73 2.034a10.014 10.014 0 0 0-4.489 2.582c-3.898 3.898-3.898 10.243 0 14.143a9.937 9.937 0 0 0 7.072 2.93 9.93 9.93 0 0 0 7.07-2.929 10.007 10.007 0 0 0 2.583-4.491 1.001 1.001 0 0 0-1.224-1.224zm-2.772 4.301a7.947 7.947 0 0 1-5.656 2.343 7.953 7.953 0 0 1-5.658-2.344c-3.118-3.119-3.118-8.195 0-11.314a7.923 7.923 0 0 1 2.06-1.483 10.027 10.027 0 0 0 2.89 7.848 9.972 9.972 0 0 0 7.848 2.891 8.036 8.036 0 0 1-1.484 2.059z" class=astro-3EF6KSR2></path></svg> <svg class=astro-3EF6KSR2 xmlns=http://www.w3.org/2000/svg id=sun-svg><path d="M6.993 12c0 2.761 2.246 5.007 5.007 5.007s5.007-2.246 5.007-5.007S14.761 6.993 12 6.993 6.993 9.239 6.993 12zM12 8.993c1.658 0 3.007 1.349 3.007 3.007S13.658 15.007 12 15.007 8.993 13.658 8.993 12 10.342 8.993 12 8.993zM10.998 19h2v3h-2zm0-17h2v3h-2zm-9 9h3v2h-3zm17 0h3v2h-3zM4.219 18.363l2.12-2.122 1.415 1.414-2.12 2.122zM16.24 6.344l2.122-2.122 1.414 1.414-2.122 2.122zM6.342 7.759 4.22 5.637l1.415-1.414 2.12 2.122zm13.434 10.605-1.414 1.414-2.122-2.122 1.414-1.414z" class=astro-3EF6KSR2></path></svg></button></li></ul></nav></div></div><div class="max-w-3xl mx-auto px-4"><hr aria-hidden=true class=border-skin-line></div></header><div class="astro-VJ4TPSPI flex justify-start max-w-3xl mx-auto px-2 w-full"><button class="astro-VJ4TPSPI flex focus-outline hover:opacity-75 mb-2 mt-8" onclick=history.back()><svg class=astro-VJ4TPSPI xmlns=http://www.w3.org/2000/svg><path d="M13.293 6.293 7.586 12l5.707 5.707 1.414-1.414L10.414 12l4.293-4.293z" class=astro-VJ4TPSPI></path></svg><span class=astro-VJ4TPSPI>Go back</span></button></div><main class=astro-VJ4TPSPI id=main-content><h1 class="astro-VJ4TPSPI post-title">Scheme初探</h1><div class="astro-VJ4TPSPI flex items-center my-2 opacity-80 space-x-2"><svg class="inline-block fill-skin-base h-6 scale-100 w-6" xmlns=http://www.w3.org/2000/svg aria-hidden=true><path d="M7 11h2v2H7zm0 4h2v2H7zm4-4h2v2h-2zm0 4h2v2h-2zm4-4h2v2h-2zm0 4h2v2h-2z"></path><path d="M5 22h14c1.103 0 2-.897 2-2V6c0-1.103-.897-2-2-2h-2V2h-2v2H9V2H7v2H5c-1.103 0-2 .897-2 2v14c0 1.103.897 2 2 2zM19 8l.001 12H5V8h14z"></path></svg><span class=sr-only>Posted on:</span><span class="italic text-base">December 24, 2014<span aria-hidden=true> | </span><span class=sr-only> at </span>07:27 AM</span></div><article class="astro-VJ4TPSPI max-w-3xl mx-auto mt-8 prose" id=article role=article><h2 id=table-of-contents>Table of contents</h2><p></p><details><summary>Open Table of contents</summary><p></p><ul><li><p><a href=#%E5%9F%BA%E6%9C%AC%E4%BB%8B%E7%BB%8D>基本介绍</a></p></li><li><p><a href=#lets-start>Let’s start</a></p><ul><li><a href=#scheme-%E5%9F%BA%E6%9C%AC%E8%AF%AD%E6%B3%95>Scheme 基本语法</a></li><li><a href=#recursion%E9%80%92%E5%BD%92>recursion(递归)</a></li><li><a href=#%E5%AE%9E%E7%8E%B0%E5%8A%A0%E5%87%8F%E4%B9%98%E9%99%A4>实现加减乘除</a></li><li><a href=#%E9%82%B1%E5%A5%87%E6%95%B0>邱奇数</a></li><li><a href=#%E5%B8%B8%E7%94%A8%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E5%92%8C%E6%93%8D%E4%BD%9C>常用数据结构和操作</a></li><li><a href=#continuation>continuation</a></li><li><a href=#halting-problem>halting problem</a></li><li><a href=#y-combinator>Y Combinator</a></li><li><a href=#interpreter>Interpreter</a></li></ul></li><li><p><a href=#commandments>Commandments</a></p></li><li><p><a href=#code>Code</a></p></li></ul><p></p></details><p></p><h2 id=基本介绍>基本介绍</h2><p>最近在学习<a href=http://zh.wikipedia.org/wiki/Scheme>Scheme</a>，来自 MIT 的一个著名的<a href=http://zh.wikipedia.org/wiki/Lisp>Lisp</a>方言。它诞生于 1975 年，和 c 语言(1972)算是同龄，对比现在当道的 90 后语言(java, javascript, php, python, ruby… )，在这日新月异的程序界，算得上是“老掉牙”了。</p><p>那么问题来了，有这工夫，为啥不学学新潮的<a href=http://zh.wikipedia.org/wiki/Go>Go</a>, <a href=http://zh.wikipedia.org/wiki/Rust>Rust</a>，偏偏学一个这么古老的语言？</p><p>答案很简单: Scheme 简洁优雅强大，直指编程本质。学之能去芜存精，助我们提升编程水平。</p><p>关于 Scheme 的书籍最有名的当属 MIT 的<a href=http://zh.wikipedia.org/wiki/%E8%A8%88%E7%AE%97%E6%A9%9F%E7%A8%8B%E5%BA%8F%E7%9A%84%E6%A7%8B%E9%80%A0%E5%92%8C%E8%A7%A3%E9%87%8B>《计算机程序的构造和解释》</a>（SICP，或“魔法书”），到 08 年为止，曾三十年为作为 MIT 计算机科学的入门课程。</p><p>不过 SICP 虽“说”是<code>入门</code>，其实又厚又深，所以我选择了另一本经典书籍作为入门：<a href=http://book.douban.com/subject/1632977/ >The Little Schemer</a>。这本书仅仅 200 页，且通篇都由<code>question&#x26;answer</code>的对话构成，由浅入深，深入浅出，从 lambda 以及几个 built-in 函数出发，一路推导出各种运算方法、数据结构，并深入到 continuation，停机问题，Y-combinator, 甚至最后直接写了个简单的解释器出来，令人惊叹。</p><p>事实上，本文可算是<code>The Little Schemer</code>的笔记和总结。</p><h2 id=lets-start>Let’s start</h2><p>我使用的 scheme 实现是<a href=http://www.gnu.org/software/guile/ >Guile</a>, 然后在<a href=http://zh.wikipedia.org/wiki/Emacs>emacs</a>中使用了<a href=http://baike.baidu.com/view/1928287.htm>王垠</a>的 scheme 配置, 配置文件在<a href=https://github.com/martin-liu/prelude/blob/master/personal/scheme.el>这里</a></p><h3 id=scheme-基本语法>Scheme 基本语法</h3><p>Scheme 的语法就是 Lisp 语法，括号套括号…很多人不爽 lisp 满屏的括号，觉得可读性差。不过，可读性应该是用缩进来保证的，任何语言的 code，不用换行和缩进，都不能谈可读性。</p><p>事实上，由于 Lisp 的程序和数据是同一种表达方式(列表)——本质上就是<a href=http://zh.wikipedia.org/wiki/%E6%8A%BD%E8%B1%A1%E8%AA%9E%E6%B3%95%E6%A8%B9>AST</a>的前缀表示——这给了 lisp 无与伦比的表达力和扩展性。</p><p>下面简单说一下其语法元素:</p><ul><li>原子（atom）和列表（list）</li></ul><p>表达式只有两种, <code>atom</code>和<code>list</code>, atom 是 number 或者 symbol(类似于 string), list 就是那坨括号</p><pre class="astro-code one-dark-pro" is:raw="" style=background-color:#282c34;overflow-x:auto;white-space:pre-wrap;word-wrap:break-word tabindex=0><code><span class=line><span style=color:#abb2bf>3                                       </span><span style=color:#7f848e;font-style:italic>; 数字3</span></span>
<span class=line><span style=color:#abb2bf>1.14                                    </span><span style=color:#7f848e;font-style:italic>; 数字1.14</span></span>
<span class=line><span style=color:#abb2bf>#t                                     </span><span style=color:#7f848e;font-style:italic>; boolean True</span></span>
<span class=line><span style=color:#abb2bf>#f                                     </span><span style=color:#7f848e;font-style:italic>; boolean False</span></span>
<span class=line><span style=color:#abb2bf>abc                                     </span><span style=color:#7f848e;font-style:italic>; simbol abc</span></span>
<span class=line><span style=color:#abb2bf>()                                      </span><span style=color:#7f848e;font-style:italic>; empty list</span></span>
<span class=line><span style=color:#abb2bf>(abc xyz)                               </span><span style=color:#7f848e;font-style:italic>; list</span></span>
<span class=line><span style=color:#abb2bf>(</span><span style=color:#56b6c2>+</span><span style=color:#abb2bf> </span><span style=color:#d19a66>1</span><span style=color:#abb2bf> (</span><span style=color:#56b6c2>-</span><span style=color:#abb2bf> </span><span style=color:#d19a66>3</span><span style=color:#abb2bf> </span><span style=color:#d19a66>2</span><span style=color:#abb2bf>))                           </span><span style=color:#7f848e;font-style:italic>; nested list</span></span></code></pre><ul><li><a href=http://zh.wikipedia.org/wiki/%CE%9B%E6%BC%94%E7%AE%97>lambda</a></li></ul><pre class="astro-code one-dark-pro" is:raw="" style=background-color:#282c34;overflow-x:auto;white-space:pre-wrap;word-wrap:break-word tabindex=0><code><span class=line><span style=color:#abb2bf> (</span><span style=color:#c678dd>lambda</span><span style=color:#abb2bf> (</span><span style=color:#e06c75;font-style:italic>x</span><span style=color:#abb2bf>)</span></span>
<span class=line><span style=color:#abb2bf>   (</span><span style=color:#56b6c2>+</span><span style=color:#abb2bf> x </span><span style=color:#d19a66>1</span><span style=color:#abb2bf>))</span></span></code></pre><p>其实就是匿名函数，等同于 javascript 里的:</p><pre class="astro-code one-dark-pro" is:raw="" style=background-color:#282c34;overflow-x:auto;white-space:pre-wrap;word-wrap:break-word tabindex=0><code><span class=line><span style=color:#c678dd>function</span><span style=color:#abb2bf>(</span><span style=color:#e06c75;font-style:italic>x</span><span style=color:#abb2bf>){</span></span>
<span class=line><span style=color:#abb2bf>  </span><span style=color:#c678dd>return</span><span style=color:#abb2bf> </span><span style=color:#e06c75>x</span><span style=color:#abb2bf> </span><span style=color:#56b6c2>+</span><span style=color:#abb2bf> </span><span style=color:#d19a66>1</span><span style=color:#abb2bf>;</span></span>
<span class=line><span style=color:#abb2bf>}</span></span></code></pre><ul><li>基本操作符，built-in 函数</li></ul><p>注意这里不是在说 Lisp 的 7 公理，也不是列出所有 scheme 的 built-in 函数，而是在<code>The Little Schemer</code>中<strong>必需</strong>的函数</p><ol><li><p>quote</p><p><code>(quote x)</code>返回 x, 等价的写法是<code>'x</code>, <code>'</code>是一个语法糖。quote 的作用是<code>区分代码和数据</code>，比如<code>(+ 1 2)</code>表示代码，执行结果为 3；而<code>'(+ 1 2)</code>表示数据，执行结果为<code>(+ 1 2)</code>这个 list</p></li><li><p>cons, 用来构造 list</p><p><code>(cons 'a 'b)</code>返回<code>(a . b)</code>, 这个叫做 dotted pair。 dotted pair 是 list 的基本组成元素，<code>(cons 'a '())</code>返回的是<code>(a . ())</code>, 我们将这种结构叫做 list, 并<code>简写</code>为<code>(a)</code>；同理，<code>(cons 'a '(b))</code>返回<code>(a . (b . ()))</code>, 我们简写为<code>(a b)</code></p></li><li><p>car, 返回 list 的第一个元素</p><p><code>(car '(a b)</code>返回<code>a</code></p></li><li><p>cdr, 返回除第一个元素的所有元素组成的表</p><p><code>(cdr '(a b c))</code>返回<code>(b c)</code></p></li><li><p>cond, and, or, not, 条件语句</p><pre class="astro-code one-dark-pro" is:raw="" style=background-color:#282c34;overflow-x:auto;white-space:pre-wrap;word-wrap:break-word tabindex=0><code><span class=line><span style=color:#abb2bf>(</span><span style=color:#c678dd>cond</span></span>
<span class=line><span style=color:#abb2bf>   (condition1 return1)</span></span>
<span class=line><span style=color:#abb2bf>   (condition2 return2)</span></span>
<span class=line><span style=color:#abb2bf>   ...</span></span>
<span class=line><span style=color:#abb2bf>   </span><span style=color:#c678dd>else</span><span style=color:#abb2bf> default)</span></span></code></pre></li><li><p>null?, 判断是否为空 list</p><p><code>(null? '())</code>返回<code>#t</code>, <code>(null? OTHERS)</code>返回<code>#f</code></p></li><li><p>eq?, 判断是否相等</p></li><li><p>atom?, 判断是否为 atom, 不是 list 的就是 atom</p></li><li><p>zero?, 判断数字是否为 0</p></li><li><p>add1, 数字加 1</p></li><li><p>sub1, 数字减 1</p></li><li><p>number?, 判断是否为数字</p></li></ol><p>好了，没有了，就这些，让我们开始奇妙的编程之旅吧！</p><p>等等‼ 纳尼？就这些？它喵的，<code>+、-、*、/、>、&#x3C;</code>都没有, for loop, while loop 也没有，这能编程？😮</p><p>别急，让我们一点点来，让我们尝试去构造它们，看看那些熟悉的编程元素，是否真的必不可少。在这个过程里，也让我们去思考也去寻找，有关编程的一些更本质的东西。</p><h3 id=recursion递归>recursion(递归)</h3><p>没有循环，那我们如何去处理重复操作？答案是递归。比如阶乘：</p><pre class="astro-code one-dark-pro" is:raw="" style=background-color:#282c34;overflow-x:auto;white-space:pre-wrap;word-wrap:break-word tabindex=0><code><span class=line><span style=color:#abb2bf>(</span><span style=color:#c678dd>define</span><span style=color:#abb2bf> </span><span style=color:#e06c75>fact</span></span>
<span class=line><span style=color:#abb2bf>  (</span><span style=color:#c678dd>lambda</span><span style=color:#abb2bf> (</span><span style=color:#e06c75;font-style:italic>x</span><span style=color:#abb2bf>)</span></span>
<span class=line><span style=color:#abb2bf>    (</span><span style=color:#c678dd>cond</span></span>
<span class=line><span style=color:#abb2bf>      ((</span><span style=color:#56b6c2>eq?</span><span style=color:#abb2bf> x </span><span style=color:#d19a66>1</span><span style=color:#abb2bf>) </span><span style=color:#d19a66>1</span><span style=color:#abb2bf>)</span></span>
<span class=line><span style=color:#abb2bf>      (</span><span style=color:#c678dd>else</span><span style=color:#abb2bf> (</span><span style=color:#56b6c2>*</span><span style=color:#abb2bf> x (fact (</span><span style=color:#56b6c2>-</span><span style=color:#abb2bf> x </span><span style=color:#d19a66>1</span><span style=color:#abb2bf>)))))))</span></span></code></pre><p>递归强大而易读，有简洁的数学美。我们只需要：</p><ol><li>设置一个<code>终止条件</code>，以便递归返回，比如<code>(eq? x 1)</code>则返回<code>1</code></li><li>改变参数值，让它<code>朝终止条件靠近</code>(这样才能最终结束)，比如<code>(- x 1)</code></li><li>以新的参数，递归调用自身，此时我们<code>假设</code>这个函数已经是 work 的，并以此填充表达式</li></ol><p>可以看到，递归和<a href=http://zh.wikipedia.org/wiki/%E6%95%B0%E5%AD%A6%E5%BD%92%E7%BA%B3%E6%B3%95>数学归纳法</a>十分类似：先考虑<code>x = 1</code>的情况，再假设<code>x = k - 1</code>时是 work 的，然后考虑<code>x = k</code>时的情况。这个过程充分展现了强大的数学美。</p><p>然而，我们常常听到一个说法：避免递归，多用循环(迭代)。这在一般情况下（比如 c、java 程序里）是正确的，因为递归会不断进行函数调用，系统需要保存调用信息和返回地址到<a href=http://zh.wikipedia.org/wiki/%E8%B0%83%E7%94%A8%E6%A0%88>调用栈</a>，这样不仅性能慢，而且容易栈溢出。</p><p>但是在<a href=http://zh.wikipedia.org/zh-hk/%E5%87%BD%E6%95%B8%E7%A8%8B%E5%BC%8F%E8%AA%9E%E8%A8%80>函数式编程</a>语言里，一般都支持<a href=http://zh.wikipedia.org/wiki/%E5%B0%BE%E8%B0%83%E7%94%A8>尾递归</a>优化（javascript 的话，ES6 将支持尾递归优化, excited!），可以很好的解决这个问题。不过在这里我们主要考虑编程的思想，优化之类的问题先不多谈。</p><p>另外，如果细心的话，你可能会发现，刚才的阶乘算法里的<code>define</code>, 并不在之前提到的 built-in 的 list 里。实际上，define 也可以只是一个语法糖。难道给函数命名也不是必需的？关于这一点，我们会在之后的<code>Y-combinator</code>一节得到答案。而现在，让我们先认为 define 存在并且 work。</p><h3 id=实现加减乘除>实现加减乘除</h3><p>让我们来实现那些基本的运算。注意，我们暂时只考虑<code>自然数</code>的情况。</p><ul><li>加法</li></ul><p>我们可以使用<code>add1</code>, <code>sub1</code>以及<code>zero?</code>来实现加法。对于<code>n + m</code>, 当<code>m</code>为<code>0</code>时，返回<code>n</code>，这是设置一个停止条件；然后让<code>m</code>往<code>0</code>逼近，递归调用加法函数即可。代码如下:</p><pre class="astro-code one-dark-pro" is:raw="" style=background-color:#282c34;overflow-x:auto;white-space:pre-wrap;word-wrap:break-word tabindex=0><code><span class=line><span style=color:#abb2bf>(</span><span style=color:#c678dd>define</span><span style=color:#abb2bf> </span><span style=color:#56b6c2>+</span></span>
<span class=line><span style=color:#abb2bf>  (</span><span style=color:#c678dd>lambda</span><span style=color:#abb2bf> (</span><span style=color:#e06c75;font-style:italic>n m</span><span style=color:#abb2bf>)</span></span>
<span class=line><span style=color:#abb2bf>    (</span><span style=color:#c678dd>cond</span></span>
<span class=line><span style=color:#abb2bf>     ((</span><span style=color:#56b6c2>zero?</span><span style=color:#abb2bf> m) n)</span></span>
<span class=line><span style=color:#abb2bf>     (</span><span style=color:#c678dd>else</span><span style=color:#abb2bf> (add1 (</span><span style=color:#56b6c2>+</span><span style=color:#abb2bf> n (sub1 m)))))))</span></span></code></pre><ul><li>减法</li></ul><pre class="astro-code one-dark-pro" is:raw="" style=background-color:#282c34;overflow-x:auto;white-space:pre-wrap;word-wrap:break-word tabindex=0><code><span class=line><span style=color:#abb2bf>(</span><span style=color:#c678dd>define</span><span style=color:#abb2bf> </span><span style=color:#56b6c2>-</span></span>
<span class=line><span style=color:#abb2bf>  (</span><span style=color:#c678dd>lambda</span><span style=color:#abb2bf> (</span><span style=color:#e06c75;font-style:italic>n m</span><span style=color:#abb2bf>)</span></span>
<span class=line><span style=color:#abb2bf>    (</span><span style=color:#c678dd>cond</span></span>
<span class=line><span style=color:#abb2bf>     ((</span><span style=color:#56b6c2>zero?</span><span style=color:#abb2bf> m) n)</span></span>
<span class=line><span style=color:#abb2bf>     (</span><span style=color:#c678dd>else</span><span style=color:#abb2bf> (sub1 (</span><span style=color:#56b6c2>-</span><span style=color:#abb2bf> n (sub1 m)))))))</span></span></code></pre><ul><li>乘法, 有了加法，乘法就自然有了</li></ul><pre class="astro-code one-dark-pro" is:raw="" style=background-color:#282c34;overflow-x:auto;white-space:pre-wrap;word-wrap:break-word tabindex=0><code><span class=line><span style=color:#abb2bf>(</span><span style=color:#c678dd>define</span><span style=color:#abb2bf> </span><span style=color:#56b6c2>*</span></span>
<span class=line><span style=color:#abb2bf>  (</span><span style=color:#c678dd>lambda</span><span style=color:#abb2bf> (</span><span style=color:#e06c75;font-style:italic>n m</span><span style=color:#abb2bf>)</span></span>
<span class=line><span style=color:#abb2bf>    (</span><span style=color:#c678dd>cond</span></span>
<span class=line><span style=color:#abb2bf>     ((</span><span style=color:#56b6c2>zero?</span><span style=color:#abb2bf> m) </span><span style=color:#d19a66>0</span><span style=color:#abb2bf>)</span></span>
<span class=line><span style=color:#abb2bf>     (</span><span style=color:#c678dd>else</span><span style=color:#abb2bf> (</span><span style=color:#56b6c2>+</span><span style=color:#abb2bf> n (</span><span style=color:#56b6c2>*</span><span style=color:#abb2bf> n (sub1 m)))))))</span></span></code></pre><ul><li><code>></code>, <code>&#x3C;</code>, 还有数字的<code>=</code>, 因为<code>eq?</code>是一个更大的 scope</li></ul><pre class="astro-code one-dark-pro" is:raw="" style=background-color:#282c34;overflow-x:auto;white-space:pre-wrap;word-wrap:break-word tabindex=0><code><span class=line><span style=color:#7f848e;font-style:italic>;; define ></span></span>
<span class=line><span style=color:#abb2bf>(</span><span style=color:#c678dd>define</span><span style=color:#abb2bf> </span><span style=color:#56b6c2>></span></span>
<span class=line><span style=color:#abb2bf>  (</span><span style=color:#c678dd>lambda</span><span style=color:#abb2bf> (</span><span style=color:#e06c75;font-style:italic>n m</span><span style=color:#abb2bf>)</span></span>
<span class=line><span style=color:#abb2bf>    (</span><span style=color:#c678dd>cond</span></span>
<span class=line><span style=color:#abb2bf>     ((</span><span style=color:#56b6c2>zero?</span><span style=color:#abb2bf> n) </span><span style=color:#d19a66>#f</span><span style=color:#abb2bf>)</span></span>
<span class=line><span style=color:#abb2bf>     ((</span><span style=color:#56b6c2>zero?</span><span style=color:#abb2bf> m) </span><span style=color:#d19a66>#t</span><span style=color:#abb2bf>)</span></span>
<span class=line><span style=color:#abb2bf>     (</span><span style=color:#c678dd>else</span><span style=color:#abb2bf> (</span><span style=color:#56b6c2>></span><span style=color:#abb2bf> (sub1 n) (sub1 m))))))</span></span>
<span class=line><span style=color:#7f848e;font-style:italic>;; define &#x3C;</span></span>
<span class=line><span style=color:#abb2bf>(</span><span style=color:#c678dd>define</span><span style=color:#abb2bf> </span><span style=color:#56b6c2>&#x3C;</span></span>
<span class=line><span style=color:#abb2bf>  (</span><span style=color:#c678dd>lambda</span><span style=color:#abb2bf> (</span><span style=color:#e06c75;font-style:italic>n m</span><span style=color:#abb2bf>)</span></span>
<span class=line><span style=color:#abb2bf>    (</span><span style=color:#c678dd>cond</span></span>
<span class=line><span style=color:#abb2bf>     ((</span><span style=color:#56b6c2>zero?</span><span style=color:#abb2bf> m) </span><span style=color:#d19a66>#f</span><span style=color:#abb2bf>)</span></span>
<span class=line><span style=color:#abb2bf>     ((</span><span style=color:#56b6c2>zero?</span><span style=color:#abb2bf> n) </span><span style=color:#d19a66>#t</span><span style=color:#abb2bf>)</span></span>
<span class=line><span style=color:#abb2bf>     (</span><span style=color:#c678dd>else</span><span style=color:#abb2bf> (</span><span style=color:#56b6c2>&#x3C;</span><span style=color:#abb2bf> (sub1 n) (sub1 m))))))</span></span>
<span class=line><span style=color:#7f848e;font-style:italic>;; define =</span></span>
<span class=line><span style=color:#abb2bf>(</span><span style=color:#c678dd>define</span><span style=color:#abb2bf> </span><span style=color:#56b6c2>=</span></span>
<span class=line><span style=color:#abb2bf>  (</span><span style=color:#c678dd>lambda</span><span style=color:#abb2bf> (</span><span style=color:#e06c75;font-style:italic>n m</span><span style=color:#abb2bf>)</span></span>
<span class=line><span style=color:#abb2bf>    (</span><span style=color:#c678dd>cond</span></span>
<span class=line><span style=color:#abb2bf>     ((</span><span style=color:#56b6c2>></span><span style=color:#abb2bf> n m) </span><span style=color:#d19a66>#f</span><span style=color:#abb2bf>)</span></span>
<span class=line><span style=color:#abb2bf>     ((</span><span style=color:#56b6c2>&#x3C;</span><span style=color:#abb2bf> n m) </span><span style=color:#d19a66>#f</span><span style=color:#abb2bf>)</span></span>
<span class=line><span style=color:#abb2bf>     (</span><span style=color:#c678dd>else</span><span style=color:#abb2bf> </span><span style=color:#d19a66>#t</span><span style=color:#abb2bf>))))</span></span></code></pre><ul><li>除法</li></ul><pre class="astro-code one-dark-pro" is:raw="" style=background-color:#282c34;overflow-x:auto;white-space:pre-wrap;word-wrap:break-word tabindex=0><code><span class=line><span style=color:#abb2bf>(</span><span style=color:#c678dd>define</span><span style=color:#abb2bf> </span><span style=color:#56b6c2>/</span></span>
<span class=line><span style=color:#abb2bf>  (</span><span style=color:#c678dd>lambda</span><span style=color:#abb2bf> (</span><span style=color:#e06c75;font-style:italic>n m</span><span style=color:#abb2bf>)</span></span>
<span class=line><span style=color:#abb2bf>    (</span><span style=color:#c678dd>cond</span></span>
<span class=line><span style=color:#abb2bf>     ((</span><span style=color:#56b6c2>&#x3C;</span><span style=color:#abb2bf> n m) </span><span style=color:#d19a66>0</span><span style=color:#abb2bf>)</span></span>
<span class=line><span style=color:#abb2bf>     (</span><span style=color:#c678dd>else</span><span style=color:#abb2bf> (add1 (</span><span style=color:#56b6c2>/</span><span style=color:#abb2bf> (</span><span style=color:#56b6c2>-</span><span style=color:#abb2bf> n m) m))))))</span></span></code></pre><ul><li>求余</li></ul><pre class="astro-code one-dark-pro" is:raw="" style=background-color:#282c34;overflow-x:auto;white-space:pre-wrap;word-wrap:break-word tabindex=0><code><span class=line><span style=color:#abb2bf>(</span><span style=color:#c678dd>define</span><span style=color:#abb2bf> %</span></span>
<span class=line><span style=color:#abb2bf>  (</span><span style=color:#c678dd>lambda</span><span style=color:#abb2bf> (</span><span style=color:#e06c75;font-style:italic>n m</span><span style=color:#abb2bf>)</span></span>
<span class=line><span style=color:#abb2bf>    (</span><span style=color:#c678dd>cond</span></span>
<span class=line><span style=color:#abb2bf>     ((</span><span style=color:#56b6c2>&#x3C;</span><span style=color:#abb2bf> n m) n)</span></span>
<span class=line><span style=color:#abb2bf>     ((</span><span style=color:#56b6c2>=</span><span style=color:#abb2bf> n m) </span><span style=color:#d19a66>0</span><span style=color:#abb2bf>)</span></span>
<span class=line><span style=color:#abb2bf>     (</span><span style=color:#c678dd>else</span></span>
<span class=line><span style=color:#abb2bf>      (% (</span><span style=color:#56b6c2>-</span><span style=color:#abb2bf> n m) m)))))</span></span></code></pre><p>漂亮！可以看到，通过 lambda 和递归，我们只使用<code>zero?</code>, <code>add1</code>, <code>sub1</code>，便实现了加减乘除，求余，还有大于、小于、相等的判定功能。🙂</p><h3 id=邱奇数>邱奇数</h3><p>值得一题的是，<code>The Little Schemer</code>里还略微探讨了一下类似<a href=http://zh.wikipedia.org/wiki/%E9%82%B1%E5%A5%87%E6%95%B0>邱奇数</a>的问题，当然不是真的邱奇数，而是类似邱奇数的简化版，且同样只考虑自然数。</p><p>简单的说，就是用<code>()</code>表示 0，<code>(())</code>表示 1，<code>(()())</code>表示 2，循环往复。</p><pre class="astro-code one-dark-pro" is:raw="" style=background-color:#282c34;overflow-x:auto;white-space:pre-wrap;word-wrap:break-word tabindex=0><code><span class=line><span style=color:#7f848e;font-style:italic>;; use '() to represent 0, '(()) represent 1</span></span>
<span class=line><span style=color:#abb2bf>(</span><span style=color:#c678dd>define</span><span style=color:#abb2bf> </span><span style=color:#e06c75>sero?</span></span>
<span class=line><span style=color:#abb2bf>  (</span><span style=color:#c678dd>lambda</span><span style=color:#abb2bf> (</span><span style=color:#e06c75;font-style:italic>n</span><span style=color:#abb2bf>)</span></span>
<span class=line><span style=color:#abb2bf>    (</span><span style=color:#56b6c2>null?</span><span style=color:#abb2bf> n)))</span></span>
<span class=line><span style=color:#abb2bf>(</span><span style=color:#c678dd>define</span><span style=color:#abb2bf> </span><span style=color:#e06c75>edd1</span></span>
<span class=line><span style=color:#abb2bf>  (</span><span style=color:#c678dd>lambda</span><span style=color:#abb2bf> (</span><span style=color:#e06c75;font-style:italic>n</span><span style=color:#abb2bf>)</span></span>
<span class=line><span style=color:#abb2bf>    (</span><span style=color:#56b6c2>cons</span><span style=color:#abb2bf> </span><span style=color:#d19a66>'()</span><span style=color:#abb2bf> n)))</span></span>
<span class=line><span style=color:#abb2bf>(</span><span style=color:#c678dd>define</span><span style=color:#abb2bf> </span><span style=color:#e06c75>zub1</span></span>
<span class=line><span style=color:#abb2bf>  (</span><span style=color:#c678dd>lambda</span><span style=color:#abb2bf> (</span><span style=color:#e06c75;font-style:italic>n</span><span style=color:#abb2bf>)</span></span>
<span class=line><span style=color:#abb2bf>    (</span><span style=color:#56b6c2>cdr</span><span style=color:#abb2bf> n)))</span></span></code></pre><p>以上是新版本的<code>zero?</code>, <code>add1</code>和<code>sub1</code>。有了这几个，根据上一节的 code，我们就可以<code>抛开数字</code>，玩转各种运算了!😏</p><h3 id=常用数据结构和操作>常用数据结构和操作</h3><p>Scheme 里只有链表，不过，其它数据结构都可以由链表来模拟或生成，比如 array, set, map(table)</p><p>当数组用：</p><pre class="astro-code one-dark-pro" is:raw="" style=background-color:#282c34;overflow-x:auto;white-space:pre-wrap;word-wrap:break-word tabindex=0><code><span class=line><span style=color:#7f848e;font-style:italic>;; (pick n lat), get the element of lat in position n</span></span>
<span class=line><span style=color:#abb2bf>(</span><span style=color:#c678dd>define</span><span style=color:#abb2bf> </span><span style=color:#e06c75>pick</span></span>
<span class=line><span style=color:#abb2bf>  (</span><span style=color:#c678dd>lambda</span><span style=color:#abb2bf> (</span><span style=color:#e06c75;font-style:italic>n lat</span><span style=color:#abb2bf>)</span></span>
<span class=line><span style=color:#abb2bf>    (</span><span style=color:#c678dd>cond</span></span>
<span class=line><span style=color:#abb2bf>     ((</span><span style=color:#56b6c2>zero?</span><span style=color:#abb2bf> (sub1 n)) (</span><span style=color:#56b6c2>car</span><span style=color:#abb2bf> lat))</span></span>
<span class=line><span style=color:#abb2bf>     (</span><span style=color:#c678dd>else</span><span style=color:#abb2bf> (pick (sub1 n) (</span><span style=color:#56b6c2>cdr</span><span style=color:#abb2bf> lat))))))</span></span></code></pre><p>Set:</p><pre class="astro-code one-dark-pro" is:raw="" style=background-color:#282c34;overflow-x:auto;white-space:pre-wrap;word-wrap:break-word tabindex=0><code><span class=line><span style=color:#7f848e;font-style:italic>;; makeset, make a lat to a set</span></span>
<span class=line><span style=color:#abb2bf>(</span><span style=color:#c678dd>define</span><span style=color:#abb2bf> </span><span style=color:#e06c75>makeset</span></span>
<span class=line><span style=color:#abb2bf>  (</span><span style=color:#c678dd>lambda</span><span style=color:#abb2bf> (</span><span style=color:#e06c75;font-style:italic>lat</span><span style=color:#abb2bf>)</span></span>
<span class=line><span style=color:#abb2bf>    (</span><span style=color:#c678dd>cond</span></span>
<span class=line><span style=color:#abb2bf>     ((</span><span style=color:#56b6c2>null?</span><span style=color:#abb2bf> lat) </span><span style=color:#d19a66>'()</span><span style=color:#abb2bf>)</span></span>
<span class=line><span style=color:#abb2bf>     ((member? (</span><span style=color:#56b6c2>car</span><span style=color:#abb2bf> lat) (</span><span style=color:#56b6c2>cdr</span><span style=color:#abb2bf> lat))</span></span>
<span class=line><span style=color:#abb2bf>      (makeset (</span><span style=color:#56b6c2>cdr</span><span style=color:#abb2bf> lat)))</span></span>
<span class=line><span style=color:#abb2bf>     (</span><span style=color:#c678dd>else</span><span style=color:#abb2bf> (</span><span style=color:#56b6c2>cons</span><span style=color:#abb2bf> (</span><span style=color:#56b6c2>car</span><span style=color:#abb2bf> lat) (makeset (</span><span style=color:#56b6c2>cdr</span><span style=color:#abb2bf> lat)))))))</span></span></code></pre><p>这里<code>member?</code>的代码就不贴出了</p><p>关于 Table(map), 我们一般会构造<code>Entry</code>这样的结构，在 scheme 里可以表示为<code>(keys values)</code>这样的形式，而<code>table(map)</code>就是<code>entry</code>的 list。</p><p>至于一些相应的操作方法，由于本文并非流水帐(😅), 此处就不贴出了</p><h3 id=continuation>continuation</h3><p>跟着<code>The Little Schemer</code>的步伐，我们会一路 build 出越来越复杂的方法，也会开始学会<code>abstract</code>, 通过复用来简化 code。不过，这些其实也并没有太出彩的地方。</p><p>但到了第 8 章，我们将会碰到一个神奇的东西，<a href=http://en.wikipedia.org/wiki/Continuation>continuation</a>。</p><p>讲 continuation 之前，我先简单说一下<a href=http://en.wikipedia.org/wiki/Continuation-passing_style>continuation-passing style (CPS)</a>。 在 JavaScript 程序里, 我们经常会用到<code>回调函数</code>，比如 ajax call：</p><pre class="astro-code one-dark-pro" is:raw="" style=background-color:#282c34;overflow-x:auto;white-space:pre-wrap;word-wrap:break-word tabindex=0><code><span class=line><span style=color:#e5c07b>$</span><span style=color:#abb2bf>.</span><span style=color:#61afef>getJSON</span><span style=color:#abb2bf>(</span><span style=color:#98c379>"ajax/test.json"</span><span style=color:#abb2bf>, </span><span style=color:#c678dd>function</span><span style=color:#abb2bf> (</span><span style=color:#e06c75;font-style:italic>data</span><span style=color:#abb2bf>) {</span></span>
<span class=line><span style=color:#abb2bf>  </span><span style=color:#e5c07b>console</span><span style=color:#abb2bf>.</span><span style=color:#61afef>log</span><span style=color:#abb2bf>(</span><span style=color:#e06c75>data</span><span style=color:#abb2bf>);</span></span>
<span class=line><span style=color:#abb2bf>});</span></span></code></pre><p><code>getJSON</code>异步拿到数据后，便会执行 pass 进去的 function，而这个 funcion 就是 continuation 了。</p><p>有朋友可能会觉得，哎哟，不就是回调嘛，这有什么了不起的？</p><p>当然不只是回调。所谓 continuation，其实是对程序的<a href=http://en.wikipedia.org/wiki/Control_flow>控制流</a>的抽象表示。上面的例子里，<code>getJSON</code>执行完后，控制流转到传入的匿名函数，在这里，实际上控制流是由我们所控制。 如果使用这种 style，我们甚至不再需要<code>return</code>。 比如将</p><pre class="astro-code one-dark-pro" is:raw="" style=background-color:#282c34;overflow-x:auto;white-space:pre-wrap;word-wrap:break-word tabindex=0><code><span class=line><span style=color:#c678dd>function</span><span style=color:#abb2bf> </span><span style=color:#61afef>f</span><span style=color:#abb2bf>(</span><span style=color:#e06c75;font-style:italic>a</span><span style=color:#abb2bf>) {</span></span>
<span class=line><span style=color:#abb2bf>  </span><span style=color:#c678dd>return</span><span style=color:#abb2bf> </span><span style=color:#e06c75>a</span><span style=color:#abb2bf>;</span></span>
<span class=line><span style=color:#abb2bf>}</span></span></code></pre><p>改成：</p><pre class="astro-code one-dark-pro" is:raw="" style=background-color:#282c34;overflow-x:auto;white-space:pre-wrap;word-wrap:break-word tabindex=0><code><span class=line><span style=color:#c678dd>function</span><span style=color:#abb2bf> </span><span style=color:#61afef>f</span><span style=color:#abb2bf>(</span><span style=color:#e06c75;font-style:italic>a</span><span style=color:#abb2bf>, </span><span style=color:#e06c75;font-style:italic>continuation</span><span style=color:#abb2bf>) {</span></span>
<span class=line><span style=color:#abb2bf>  </span><span style=color:#61afef>continuation</span><span style=color:#abb2bf>(</span><span style=color:#e06c75>a</span><span style=color:#abb2bf>);</span></span>
<span class=line><span style=color:#abb2bf>}</span></span></code></pre><p>事实上很多编译器都会做这种事情。</p><p>而更重要的是，使用 Continuation 我们可以实现更复杂的控制流，比如<a href=http://en.wikipedia.org/wiki/Exception_handling>Exception(try-catch block)</a>, <a href=http://en.wikipedia.org/wiki/Continuation>coroutine(协程)</a>, <a href=http://en.wikipedia.org/wiki/Generator_%28computer_programming%29>generator</a></p><p>对于编译器来说，可以容易的把这些复杂的结构脱糖处理，变成简单的 CPS，这将极大的简化编译器的实现。</p><p>关于 continuation 的话题可以非常大，这里篇幅有限，暂不深入讨论。我将单独开一篇博文详谈。</p><p>回到<code>The Little Schemer</code>, 我不得不贴一下里面讲解 continuation 的 code, 非常之赞，因为真正的在解决问题，而不是如我这样空泛的举例:</p><pre class="astro-code one-dark-pro" is:raw="" style=background-color:#282c34;overflow-x:auto;white-space:pre-wrap;word-wrap:break-word tabindex=0><code><span class=line><span style=color:#abb2bf>(</span><span style=color:#c678dd>define</span><span style=color:#abb2bf> </span><span style=color:#e06c75>multirember&#x26;co</span></span>
<span class=line><span style=color:#abb2bf>  </span><span style=color:#7f848e;font-style:italic>;; param: atom, list, collector</span></span>
<span class=line><span style=color:#abb2bf>  (</span><span style=color:#c678dd>lambda</span><span style=color:#abb2bf> (</span><span style=color:#e06c75;font-style:italic>a l col</span><span style=color:#abb2bf>)</span></span>
<span class=line><span style=color:#abb2bf>    (</span><span style=color:#c678dd>cond</span></span>
<span class=line><span style=color:#abb2bf>     ((</span><span style=color:#56b6c2>null?</span><span style=color:#abb2bf> l)</span></span>
<span class=line><span style=color:#abb2bf>      (col </span><span style=color:#d19a66>'()</span><span style=color:#abb2bf> </span><span style=color:#d19a66>'()</span><span style=color:#abb2bf>))</span></span>
<span class=line><span style=color:#abb2bf>     ((</span><span style=color:#56b6c2>equal?</span><span style=color:#abb2bf> a (</span><span style=color:#56b6c2>car</span><span style=color:#abb2bf> l))</span></span>
<span class=line><span style=color:#abb2bf>      (multirember&#x26;co a (</span><span style=color:#56b6c2>cdr</span><span style=color:#abb2bf> l)</span></span>
<span class=line><span style=color:#abb2bf>                      </span><span style=color:#7f848e;font-style:italic>;; 每次(cdr l), 都包一次col, seen经过(cons (car l))，收集了所有等于a的atom</span></span>
<span class=line><span style=color:#abb2bf>                      (</span><span style=color:#c678dd>lambda</span><span style=color:#abb2bf> (</span><span style=color:#e06c75;font-style:italic>newlat seen</span><span style=color:#abb2bf>)</span></span>
<span class=line><span style=color:#abb2bf>                        (col newlat</span></span>
<span class=line><span style=color:#abb2bf>                             (</span><span style=color:#56b6c2>cons</span><span style=color:#abb2bf> (</span><span style=color:#56b6c2>car</span><span style=color:#abb2bf> l) seen)))))</span></span>
<span class=line><span style=color:#abb2bf>     (</span><span style=color:#c678dd>else</span></span>
<span class=line><span style=color:#abb2bf>      (multirember&#x26;co a (</span><span style=color:#56b6c2>cdr</span><span style=color:#abb2bf> l)</span></span>
<span class=line><span style=color:#abb2bf>                      (</span><span style=color:#c678dd>lambda</span><span style=color:#abb2bf> (</span><span style=color:#e06c75;font-style:italic>newlat seen</span><span style=color:#abb2bf>)</span></span>
<span class=line><span style=color:#abb2bf>                        (col (</span><span style=color:#56b6c2>cons</span><span style=color:#abb2bf> (</span><span style=color:#56b6c2>car</span><span style=color:#abb2bf> l) newlat) seen)))))))</span></span></code></pre><p>这里很重要的一点是，我们现在并没有提供<code>局部变量</code>的功能，但是通过 continuation 来巧妙的做 collect 工作。从这个角度来讲，局部变量也可以是语法糖!</p><p>为了便于不熟悉 scheme 的人理解，我用 javascript 翻译了一下，可在 chrome develop tool 或者 firebug 里 have a try。注意，里面的局部变量仅仅是为了写的方便，理解这个意思就行。</p><pre class="astro-code one-dark-pro" is:raw="" style=background-color:#282c34;overflow-x:auto;white-space:pre-wrap;word-wrap:break-word tabindex=0><code><span class=line><span style=color:#c678dd>var</span><span style=color:#abb2bf> </span><span style=color:#61afef>multirember</span><span style=color:#abb2bf> </span><span style=color:#56b6c2>=</span><span style=color:#abb2bf> </span><span style=color:#c678dd>function</span><span style=color:#abb2bf> (</span><span style=color:#e06c75;font-style:italic>a</span><span style=color:#abb2bf>, </span><span style=color:#e06c75;font-style:italic>arr</span><span style=color:#abb2bf>, </span><span style=color:#e06c75;font-style:italic>collector</span><span style=color:#abb2bf>) {</span></span>
<span class=line><span style=color:#abb2bf>  </span><span style=color:#c678dd>var</span><span style=color:#abb2bf> </span><span style=color:#e06c75>tmp</span><span style=color:#abb2bf>;</span></span>
<span class=line><span style=color:#abb2bf>  </span><span style=color:#c678dd>if</span><span style=color:#abb2bf> (</span><span style=color:#e5c07b>arr</span><span style=color:#abb2bf>.</span><span style=color:#e06c75>length</span><span style=color:#abb2bf> </span><span style=color:#56b6c2>===</span><span style=color:#abb2bf> </span><span style=color:#d19a66>0</span><span style=color:#abb2bf>) {</span></span>
<span class=line><span style=color:#abb2bf>    </span><span style=color:#c678dd>return</span><span style=color:#abb2bf> </span><span style=color:#61afef>collector</span><span style=color:#abb2bf>([], []);</span></span>
<span class=line><span style=color:#abb2bf>  } </span><span style=color:#c678dd>else</span><span style=color:#abb2bf> {</span></span>
<span class=line><span style=color:#abb2bf>    </span><span style=color:#e06c75>tmp</span><span style=color:#abb2bf> </span><span style=color:#56b6c2>=</span><span style=color:#abb2bf> </span><span style=color:#e5c07b>arr</span><span style=color:#abb2bf>.</span><span style=color:#61afef>shift</span><span style=color:#abb2bf>();</span></span>
<span class=line><span style=color:#abb2bf>    </span><span style=color:#c678dd>if</span><span style=color:#abb2bf> (</span><span style=color:#e06c75>a</span><span style=color:#abb2bf> </span><span style=color:#56b6c2>===</span><span style=color:#abb2bf> </span><span style=color:#e06c75>tmp</span><span style=color:#abb2bf>) {</span></span>
<span class=line><span style=color:#abb2bf>      </span><span style=color:#c678dd>return</span><span style=color:#abb2bf> </span><span style=color:#61afef>multirember</span><span style=color:#abb2bf>(</span><span style=color:#e06c75>a</span><span style=color:#abb2bf>, </span><span style=color:#e06c75>arr</span><span style=color:#abb2bf>, </span><span style=color:#c678dd>function</span><span style=color:#abb2bf> (</span><span style=color:#e06c75;font-style:italic>notseen</span><span style=color:#abb2bf>, </span><span style=color:#e06c75;font-style:italic>seen</span><span style=color:#abb2bf>) {</span></span>
<span class=line><span style=color:#abb2bf>        </span><span style=color:#e06c75>seen</span><span style=color:#abb2bf> </span><span style=color:#56b6c2>=</span><span style=color:#abb2bf> [</span><span style=color:#e06c75>a</span><span style=color:#abb2bf>].</span><span style=color:#61afef>concat</span><span style=color:#abb2bf>(</span><span style=color:#e06c75>seen</span><span style=color:#abb2bf>);</span></span>
<span class=line><span style=color:#abb2bf>        </span><span style=color:#c678dd>return</span><span style=color:#abb2bf> </span><span style=color:#61afef>collector</span><span style=color:#abb2bf>(</span><span style=color:#e06c75>notseen</span><span style=color:#abb2bf>, </span><span style=color:#e06c75>seen</span><span style=color:#abb2bf>);</span></span>
<span class=line><span style=color:#abb2bf>      });</span></span>
<span class=line><span style=color:#abb2bf>    } </span><span style=color:#c678dd>else</span><span style=color:#abb2bf> {</span></span>
<span class=line><span style=color:#abb2bf>      </span><span style=color:#c678dd>return</span><span style=color:#abb2bf> </span><span style=color:#61afef>multirember</span><span style=color:#abb2bf>(</span><span style=color:#e06c75>a</span><span style=color:#abb2bf>, </span><span style=color:#e06c75>arr</span><span style=color:#abb2bf>, </span><span style=color:#c678dd>function</span><span style=color:#abb2bf> (</span><span style=color:#e06c75;font-style:italic>notseen</span><span style=color:#abb2bf>, </span><span style=color:#e06c75;font-style:italic>seen</span><span style=color:#abb2bf>) {</span></span>
<span class=line><span style=color:#abb2bf>        </span><span style=color:#e06c75>notseen</span><span style=color:#abb2bf> </span><span style=color:#56b6c2>=</span><span style=color:#abb2bf> [</span><span style=color:#e06c75>tmp</span><span style=color:#abb2bf>].</span><span style=color:#61afef>concat</span><span style=color:#abb2bf>(</span><span style=color:#e06c75>notseen</span><span style=color:#abb2bf>);</span></span>
<span class=line><span style=color:#abb2bf>        </span><span style=color:#c678dd>return</span><span style=color:#abb2bf> </span><span style=color:#61afef>collector</span><span style=color:#abb2bf>(</span><span style=color:#e06c75>notseen</span><span style=color:#abb2bf>, </span><span style=color:#e06c75>seen</span><span style=color:#abb2bf>);</span></span>
<span class=line><span style=color:#abb2bf>      });</span></span>
<span class=line><span style=color:#abb2bf>    }</span></span>
<span class=line><span style=color:#abb2bf>  }</span></span>
<span class=line><span style=color:#abb2bf>};</span></span>
<span class=line><span style=color:#61afef>multirember</span><span style=color:#abb2bf>(</span><span style=color:#d19a66>1</span><span style=color:#abb2bf>, [</span><span style=color:#d19a66>1</span><span style=color:#abb2bf>, </span><span style=color:#d19a66>2</span><span style=color:#abb2bf>, </span><span style=color:#d19a66>3</span><span style=color:#abb2bf>, </span><span style=color:#d19a66>1</span><span style=color:#abb2bf>, </span><span style=color:#d19a66>4</span><span style=color:#abb2bf>, </span><span style=color:#d19a66>5</span><span style=color:#abb2bf>, </span><span style=color:#d19a66>1</span><span style=color:#abb2bf>, </span><span style=color:#d19a66>6</span><span style=color:#abb2bf>], </span><span style=color:#c678dd>function</span><span style=color:#abb2bf> (</span><span style=color:#e06c75;font-style:italic>notseen</span><span style=color:#abb2bf>, </span><span style=color:#e06c75;font-style:italic>seen</span><span style=color:#abb2bf>) {</span></span>
<span class=line><span style=color:#abb2bf>  </span><span style=color:#e5c07b>console</span><span style=color:#abb2bf>.</span><span style=color:#61afef>log</span><span style=color:#abb2bf>(</span><span style=color:#98c379>"notseen is: "</span><span style=color:#abb2bf> </span><span style=color:#56b6c2>+</span><span style=color:#abb2bf> </span><span style=color:#e06c75>notseen</span><span style=color:#abb2bf>);</span></span>
<span class=line><span style=color:#abb2bf>  </span><span style=color:#c678dd>return</span><span style=color:#abb2bf> </span><span style=color:#e5c07b>console</span><span style=color:#abb2bf>.</span><span style=color:#61afef>log</span><span style=color:#abb2bf>(</span><span style=color:#98c379>"seen is: "</span><span style=color:#abb2bf> </span><span style=color:#56b6c2>+</span><span style=color:#abb2bf> </span><span style=color:#e06c75>seen</span><span style=color:#abb2bf>);</span></span>
<span class=line><span style=color:#abb2bf>});</span></span>
<span class=line><span style=color:#7f848e;font-style:italic>// result:</span></span>
<span class=line><span style=color:#7f848e;font-style:italic>// notseen is: 2,3,4,5,6</span></span>
<span class=line><span style=color:#7f848e;font-style:italic>// seen is: 1,1,1</span></span></code></pre><h3 id=halting-problem>halting problem</h3><p>经过 continuation 的一知半解和意犹未尽，让我们缓一缓，来看看<a href=http://zh.wikipedia.org/zh-hk/%E5%81%9C%E6%9C%BA%E9%97%AE%E9%A2%98>停机问题</a>。所谓停机问题，就是判断任意一个程序是否会在有限的时间之内结束运行的问题。</p><p>首先，我们写一个无限递归永不停机的函数：</p><pre class="astro-code one-dark-pro" is:raw="" style=background-color:#282c34;overflow-x:auto;white-space:pre-wrap;word-wrap:break-word tabindex=0><code><span class=line><span style=color:#abb2bf>(</span><span style=color:#c678dd>define</span><span style=color:#abb2bf> </span><span style=color:#e06c75>eternity</span></span>
<span class=line><span style=color:#abb2bf> (</span><span style=color:#c678dd>lambda</span><span style=color:#abb2bf> (</span><span style=color:#e06c75;font-style:italic>x</span><span style=color:#abb2bf>)</span></span>
<span class=line><span style=color:#abb2bf>  (eternity x)))</span></span></code></pre><p>然后，我们假设存在一个函数<code>will-stop?</code>能判断一个函数是否会停机。然后我们再构建一个绝妙的矛盾的函数：</p><pre class="astro-code one-dark-pro" is:raw="" style=background-color:#282c34;overflow-x:auto;white-space:pre-wrap;word-wrap:break-word tabindex=0><code><span class=line><span style=color:#abb2bf>(</span><span style=color:#c678dd>define</span><span style=color:#abb2bf> </span><span style=color:#e06c75>last-try</span></span>
<span class=line><span style=color:#abb2bf> (</span><span style=color:#c678dd>lambda</span><span style=color:#abb2bf> (</span><span style=color:#e06c75;font-style:italic>x</span><span style=color:#abb2bf>)</span></span>
<span class=line><span style=color:#abb2bf>  (</span><span style=color:#c678dd>and</span><span style=color:#abb2bf> (will-stop? last-try)</span></span>
<span class=line><span style=color:#abb2bf>       (eternity x))))</span></span></code></pre><p>如果<code>last-try</code>会停机，即<code>(will-stop? last-try)</code>返回#t，将执行<code>eternity</code>，于是无限递归永不停机；如果<code>last-try</code>不会停机，即<code>(will-stop? last-try)</code>返回#f，last-try 停机并返回#f。 无论哪种情况，都是矛盾的，于是证明<code>will-stop?</code>不存在，停机问题得解。</p><p>这样看起来还是蛮简单的嘛，不过，没看过我肯定想不出来。。。啥也不说了，拜谢图灵!</p><h3 id=y-combinator>Y Combinator</h3><p>在<code>The Little Schemer</code>第九章里，还有一个大名鼎鼎的东西，<a href=http://en.wikipedia.org/wiki/Fixed-point_combinator#Y_combinator>Y combinator</a>。我也曾看过一些关于它的文章，但大多都深奥晦涩，难以捉摸。而在<code>The Little Schemer</code>里，完全用 code 的方式来一步步引导出来，不过，为了接受度，且让我使用 js 来描述。</p><p>还记得我们之前提到<code>define</code>其实不是必需的么？想一想，如果我们只有 lambda，也就是只有匿名函数，可以实现递归么？</p><p>让我们试一试。</p><p>从一个简单的递归开始：</p><pre class="astro-code one-dark-pro" is:raw="" style=background-color:#282c34;overflow-x:auto;white-space:pre-wrap;word-wrap:break-word tabindex=0><code><span class=line><span style=color:#c678dd>var</span><span style=color:#abb2bf> </span><span style=color:#61afef>f</span><span style=color:#abb2bf> </span><span style=color:#56b6c2>=</span><span style=color:#abb2bf> </span><span style=color:#c678dd>function</span><span style=color:#abb2bf> (</span><span style=color:#e06c75;font-style:italic>n</span><span style=color:#abb2bf>) {</span></span>
<span class=line><span style=color:#abb2bf>  </span><span style=color:#c678dd>if</span><span style=color:#abb2bf> (</span><span style=color:#e06c75>n</span><span style=color:#abb2bf> </span><span style=color:#56b6c2>==</span><span style=color:#abb2bf> </span><span style=color:#d19a66>1</span><span style=color:#abb2bf>) {</span></span>
<span class=line><span style=color:#abb2bf>    </span><span style=color:#c678dd>return</span><span style=color:#abb2bf> </span><span style=color:#d19a66>1</span><span style=color:#abb2bf>;</span></span>
<span class=line><span style=color:#abb2bf>  } </span><span style=color:#c678dd>else</span><span style=color:#abb2bf> {</span></span>
<span class=line><span style=color:#abb2bf>    </span><span style=color:#c678dd>return</span><span style=color:#abb2bf> </span><span style=color:#e06c75>n</span><span style=color:#abb2bf> </span><span style=color:#56b6c2>*</span><span style=color:#abb2bf> </span><span style=color:#61afef>f</span><span style=color:#abb2bf>(</span><span style=color:#e06c75>n</span><span style=color:#abb2bf> </span><span style=color:#56b6c2>-</span><span style=color:#abb2bf> </span><span style=color:#d19a66>1</span><span style=color:#abb2bf>);</span></span>
<span class=line><span style=color:#abb2bf>  }</span></span>
<span class=line><span style=color:#abb2bf>};</span></span></code></pre><p>由于只有匿名函数，所以<code>f(n-1)</code>是不存在的，那么这个写法就不正确了。</p><p>不过，如果我们能给出<code>真正的递归函数</code>f，那我们就可以写出以下的函数:</p><pre class="astro-code one-dark-pro" is:raw="" style=background-color:#282c34;overflow-x:auto;white-space:pre-wrap;word-wrap:break-word tabindex=0><code><span class=line><span style=color:#c678dd>var</span><span style=color:#abb2bf> </span><span style=color:#61afef>F</span><span style=color:#abb2bf> </span><span style=color:#56b6c2>=</span><span style=color:#abb2bf> </span><span style=color:#c678dd>function</span><span style=color:#abb2bf> (</span><span style=color:#e06c75;font-style:italic>f</span><span style=color:#abb2bf>) {</span></span>
<span class=line><span style=color:#abb2bf>  </span><span style=color:#c678dd>return</span><span style=color:#abb2bf> </span><span style=color:#c678dd>function</span><span style=color:#abb2bf> (</span><span style=color:#e06c75;font-style:italic>n</span><span style=color:#abb2bf>) {</span></span>
<span class=line><span style=color:#abb2bf>    </span><span style=color:#c678dd>if</span><span style=color:#abb2bf> (</span><span style=color:#e06c75>n</span><span style=color:#abb2bf> </span><span style=color:#56b6c2>==</span><span style=color:#abb2bf> </span><span style=color:#d19a66>1</span><span style=color:#abb2bf>) {</span></span>
<span class=line><span style=color:#abb2bf>      </span><span style=color:#c678dd>return</span><span style=color:#abb2bf> </span><span style=color:#d19a66>1</span><span style=color:#abb2bf>;</span></span>
<span class=line><span style=color:#abb2bf>    } </span><span style=color:#c678dd>else</span><span style=color:#abb2bf> {</span></span>
<span class=line><span style=color:#abb2bf>      </span><span style=color:#c678dd>return</span><span style=color:#abb2bf> </span><span style=color:#e06c75>n</span><span style=color:#abb2bf> </span><span style=color:#56b6c2>*</span><span style=color:#abb2bf> </span><span style=color:#61afef>f</span><span style=color:#abb2bf>(</span><span style=color:#e06c75>n</span><span style=color:#abb2bf> </span><span style=color:#56b6c2>-</span><span style=color:#abb2bf> </span><span style=color:#d19a66>1</span><span style=color:#abb2bf>);</span></span>
<span class=line><span style=color:#abb2bf>    }</span></span>
<span class=line><span style=color:#abb2bf>  };</span></span>
<span class=line><span style=color:#abb2bf>};</span></span></code></pre><p>这个函数是可以给出的，因为<code>f(n-1)</code>里的<code>f</code>是外界传进来的，所以它是有意义的。而<code>var F</code>, 我们可以当做语法糖，因为函数定义里没有引用到它。不过，给出了<code>F</code>也不能解决问题，因为我们不知道如何给出<code>f</code>。</p><p>但是没关系，让我们一点点尝试，或许能慢慢逼近正确答案。</p><p>让我们看看<code>F(f)</code>的结果是什么?</p><pre class="astro-code one-dark-pro" is:raw="" style=background-color:#282c34;overflow-x:auto;white-space:pre-wrap;word-wrap:break-word tabindex=0><code><span class=line><span style=color:#7f848e;font-style:italic>// F(f)的展开</span></span>
<span class=line><span style=color:#c678dd>function</span><span style=color:#abb2bf>(</span><span style=color:#e06c75;font-style:italic>n</span><span style=color:#abb2bf>){</span></span>
<span class=line><span style=color:#abb2bf>    </span><span style=color:#c678dd>if</span><span style=color:#abb2bf> (</span><span style=color:#e06c75>n</span><span style=color:#abb2bf> </span><span style=color:#56b6c2>==</span><span style=color:#abb2bf> </span><span style=color:#d19a66>1</span><span style=color:#abb2bf>){</span></span>
<span class=line><span style=color:#abb2bf>        </span><span style=color:#c678dd>return</span><span style=color:#abb2bf> </span><span style=color:#d19a66>1</span><span style=color:#abb2bf>;</span></span>
<span class=line><span style=color:#abb2bf>    } </span><span style=color:#c678dd>else</span><span style=color:#abb2bf> {</span></span>
<span class=line><span style=color:#abb2bf>        </span><span style=color:#c678dd>return</span><span style=color:#abb2bf> </span><span style=color:#e06c75>n</span><span style=color:#abb2bf> </span><span style=color:#56b6c2>*</span><span style=color:#abb2bf> </span><span style=color:#61afef>f</span><span style=color:#abb2bf>(</span><span style=color:#e06c75>n</span><span style=color:#56b6c2>-</span><span style=color:#d19a66>1</span><span style=color:#abb2bf>);</span></span>
<span class=line><span style=color:#abb2bf>    }</span></span>
<span class=line><span style=color:#abb2bf>}</span></span></code></pre><p>这个<code>f</code>是我们传进去的真正的递归函数，而如果 f 是真正的递归函数，那么很明显，<code>F(f)</code>就是<code>f</code>本身。</p><p>也就是说，<code>F(f) = f</code>。很好，虽然我们还不能给出<code>f</code>，但我们能给出<code>F</code>，并找到了<code>F</code>和<code>f</code>的关系。让我们继续尝试，看能否通过<code>F</code>来最终找到<code>f</code>。</p><p>我们现在知道，<code>F(f)</code>就等于我们要找的递归函数。而 F 和 f 的定义看起来是很类似的，那我们来试试<code>F(F)</code>。<code>F(F)</code>展开的结果是:</p><pre class="astro-code one-dark-pro" is:raw="" style=background-color:#282c34;overflow-x:auto;white-space:pre-wrap;word-wrap:break-word tabindex=0><code><span class=line><span style=color:#7f848e;font-style:italic>// F(F)的展开</span></span>
<span class=line><span style=color:#c678dd>function</span><span style=color:#abb2bf>(</span><span style=color:#e06c75;font-style:italic>n</span><span style=color:#abb2bf>){</span></span>
<span class=line><span style=color:#abb2bf>    </span><span style=color:#c678dd>if</span><span style=color:#abb2bf> (</span><span style=color:#e06c75>n</span><span style=color:#abb2bf> </span><span style=color:#56b6c2>==</span><span style=color:#abb2bf> </span><span style=color:#d19a66>1</span><span style=color:#abb2bf>){</span></span>
<span class=line><span style=color:#abb2bf>        </span><span style=color:#c678dd>return</span><span style=color:#abb2bf> </span><span style=color:#d19a66>1</span><span style=color:#abb2bf>;</span></span>
<span class=line><span style=color:#abb2bf>    } </span><span style=color:#c678dd>else</span><span style=color:#abb2bf> {</span></span>
<span class=line><span style=color:#abb2bf>        </span><span style=color:#c678dd>return</span><span style=color:#abb2bf> </span><span style=color:#e06c75>n</span><span style=color:#abb2bf> </span><span style=color:#56b6c2>*</span><span style=color:#abb2bf> </span><span style=color:#61afef>F</span><span style=color:#abb2bf>(</span><span style=color:#e06c75>n</span><span style=color:#56b6c2>-</span><span style=color:#d19a66>1</span><span style=color:#abb2bf>);</span></span>
<span class=line><span style=color:#abb2bf>    }</span></span>
<span class=line><span style=color:#abb2bf>}</span></span></code></pre><p>你应该能注意到，<code>F(n-1)</code>不对，因为<code>F</code>接受一个函数作为参数。而如果从理论上递归函数的定义来看，应该是<code>F(F)(n-1)</code>才对。可以做到么？可以！我们再写一个函数 G:</p><pre class="astro-code one-dark-pro" is:raw="" style=background-color:#282c34;overflow-x:auto;white-space:pre-wrap;word-wrap:break-word tabindex=0><code><span class=line><span style=color:#c678dd>var</span><span style=color:#abb2bf> </span><span style=color:#61afef>G</span><span style=color:#abb2bf> </span><span style=color:#56b6c2>=</span><span style=color:#abb2bf> </span><span style=color:#c678dd>function</span><span style=color:#abb2bf> (</span><span style=color:#e06c75;font-style:italic>f</span><span style=color:#abb2bf>) {</span></span>
<span class=line><span style=color:#abb2bf>  </span><span style=color:#c678dd>return</span><span style=color:#abb2bf> </span><span style=color:#c678dd>function</span><span style=color:#abb2bf> (</span><span style=color:#e06c75;font-style:italic>n</span><span style=color:#abb2bf>) {</span></span>
<span class=line><span style=color:#abb2bf>    </span><span style=color:#c678dd>if</span><span style=color:#abb2bf> (</span><span style=color:#e06c75>n</span><span style=color:#abb2bf> </span><span style=color:#56b6c2>==</span><span style=color:#abb2bf> </span><span style=color:#d19a66>1</span><span style=color:#abb2bf>) {</span></span>
<span class=line><span style=color:#abb2bf>      </span><span style=color:#c678dd>return</span><span style=color:#abb2bf> </span><span style=color:#d19a66>1</span><span style=color:#abb2bf>;</span></span>
<span class=line><span style=color:#abb2bf>    } </span><span style=color:#c678dd>else</span><span style=color:#abb2bf> {</span></span>
<span class=line><span style=color:#abb2bf>      </span><span style=color:#c678dd>return</span><span style=color:#abb2bf> </span><span style=color:#e06c75>n</span><span style=color:#abb2bf> </span><span style=color:#56b6c2>*</span><span style=color:#abb2bf> </span><span style=color:#61afef>f</span><span style=color:#abb2bf>(</span><span style=color:#e06c75>f</span><span style=color:#abb2bf>)(</span><span style=color:#e06c75>n</span><span style=color:#abb2bf> </span><span style=color:#56b6c2>-</span><span style=color:#abb2bf> </span><span style=color:#d19a66>1</span><span style=color:#abb2bf>); </span><span style=color:#7f848e;font-style:italic>// 注意是f(f)</span></span>
<span class=line><span style=color:#abb2bf>    }</span></span>
<span class=line><span style=color:#abb2bf>  };</span></span>
<span class=line><span style=color:#abb2bf>};</span></span></code></pre><p>这里<code>G</code>和<code>F</code>唯一的区别就是里面递归调用的是<code>f(f)</code>而不是<code>f</code>。现在<code>G(G)</code>的展开里会是这样：</p><pre class="astro-code one-dark-pro" is:raw="" style=background-color:#282c34;overflow-x:auto;white-space:pre-wrap;word-wrap:break-word tabindex=0><code><span class=line><span style=color:#7f848e;font-style:italic>// G(G)的展开</span></span>
<span class=line><span style=color:#c678dd>function</span><span style=color:#abb2bf>(</span><span style=color:#e06c75;font-style:italic>n</span><span style=color:#abb2bf>){</span></span>
<span class=line><span style=color:#abb2bf>    </span><span style=color:#c678dd>if</span><span style=color:#abb2bf> (</span><span style=color:#e06c75>n</span><span style=color:#abb2bf> </span><span style=color:#56b6c2>==</span><span style=color:#abb2bf> </span><span style=color:#d19a66>1</span><span style=color:#abb2bf>){</span></span>
<span class=line><span style=color:#abb2bf>        </span><span style=color:#c678dd>return</span><span style=color:#abb2bf> </span><span style=color:#d19a66>1</span><span style=color:#abb2bf>;</span></span>
<span class=line><span style=color:#abb2bf>    } </span><span style=color:#c678dd>else</span><span style=color:#abb2bf> {</span></span>
<span class=line><span style=color:#abb2bf>        </span><span style=color:#c678dd>return</span><span style=color:#abb2bf> </span><span style=color:#e06c75>n</span><span style=color:#abb2bf> </span><span style=color:#56b6c2>*</span><span style=color:#abb2bf> </span><span style=color:#61afef>G</span><span style=color:#abb2bf>(</span><span style=color:#e5c07b>G</span><span style=color:#abb2bf>)(</span><span style=color:#e06c75>n</span><span style=color:#56b6c2>-</span><span style=color:#d19a66>1</span><span style=color:#abb2bf>);</span></span>
<span class=line><span style=color:#abb2bf>    }</span></span>
<span class=line><span style=color:#abb2bf>}</span></span></code></pre><p>这不就是递归函数的定义么？看起来似乎没什么问题，<code>G</code>的定义里并没有引用<code>G</code>，那么理论上说<code>G(G)</code>就是我们的递归函数了。 让我们来测试一下，<code>G(G)(5); // return 120</code>，漂亮！我们成功了！原来只需要匿名函数，我们就可以实现递归！🍻</p><p>不过，稍等一下，还差一点点，这还不是 Y-combinator，因为还不够美。让我们更进一步，把<code>f(f)</code>再抽象一下:</p><pre class="astro-code one-dark-pro" is:raw="" style=background-color:#282c34;overflow-x:auto;white-space:pre-wrap;word-wrap:break-word tabindex=0><code><span class=line><span style=color:#c678dd>var</span><span style=color:#abb2bf> </span><span style=color:#61afef>G</span><span style=color:#abb2bf> </span><span style=color:#56b6c2>=</span><span style=color:#abb2bf> </span><span style=color:#c678dd>function</span><span style=color:#abb2bf> (</span><span style=color:#e06c75;font-style:italic>f</span><span style=color:#abb2bf>) {</span></span>
<span class=line><span style=color:#abb2bf>  </span><span style=color:#c678dd>return</span><span style=color:#abb2bf> (</span><span style=color:#c678dd>function</span><span style=color:#abb2bf> (</span><span style=color:#e06c75;font-style:italic>f</span><span style=color:#abb2bf>) {</span></span>
<span class=line><span style=color:#abb2bf>    </span><span style=color:#c678dd>return</span><span style=color:#abb2bf> </span><span style=color:#c678dd>function</span><span style=color:#abb2bf> (</span><span style=color:#e06c75;font-style:italic>n</span><span style=color:#abb2bf>) {</span></span>
<span class=line><span style=color:#abb2bf>      </span><span style=color:#c678dd>if</span><span style=color:#abb2bf> (</span><span style=color:#e06c75>n</span><span style=color:#abb2bf> </span><span style=color:#56b6c2>===</span><span style=color:#abb2bf> </span><span style=color:#d19a66>1</span><span style=color:#abb2bf>) {</span></span>
<span class=line><span style=color:#abb2bf>        </span><span style=color:#c678dd>return</span><span style=color:#abb2bf> </span><span style=color:#d19a66>1</span><span style=color:#abb2bf>;</span></span>
<span class=line><span style=color:#abb2bf>      } </span><span style=color:#c678dd>else</span><span style=color:#abb2bf> {</span></span>
<span class=line><span style=color:#abb2bf>        </span><span style=color:#c678dd>return</span><span style=color:#abb2bf> </span><span style=color:#e06c75>n</span><span style=color:#abb2bf> </span><span style=color:#56b6c2>*</span><span style=color:#abb2bf> </span><span style=color:#61afef>f</span><span style=color:#abb2bf>(</span><span style=color:#e06c75>n</span><span style=color:#abb2bf> </span><span style=color:#56b6c2>-</span><span style=color:#abb2bf> </span><span style=color:#d19a66>1</span><span style=color:#abb2bf>);</span></span>
<span class=line><span style=color:#abb2bf>      }</span></span>
<span class=line><span style=color:#abb2bf>    };</span></span>
<span class=line><span style=color:#abb2bf>  })(</span><span style=color:#61afef>f</span><span style=color:#abb2bf>(</span><span style=color:#e06c75>f</span><span style=color:#abb2bf>));</span></span>
<span class=line><span style=color:#abb2bf>};</span></span></code></pre><p>不难看出，这个定义等价于之前<code>G</code>的定义。 而根据之前的<code>F</code>的定义，这实际上就是:</p><pre class="astro-code one-dark-pro" is:raw="" style=background-color:#282c34;overflow-x:auto;white-space:pre-wrap;word-wrap:break-word tabindex=0><code><span class=line><span style=color:#c678dd>var</span><span style=color:#abb2bf> </span><span style=color:#61afef>G</span><span style=color:#abb2bf> </span><span style=color:#56b6c2>=</span><span style=color:#abb2bf> </span><span style=color:#c678dd>function</span><span style=color:#abb2bf> (</span><span style=color:#e06c75;font-style:italic>f</span><span style=color:#abb2bf>) {</span></span>
<span class=line><span style=color:#abb2bf>  </span><span style=color:#c678dd>return</span><span style=color:#abb2bf> </span><span style=color:#61afef>F</span><span style=color:#abb2bf>(</span><span style=color:#61afef>f</span><span style=color:#abb2bf>(</span><span style=color:#e06c75>f</span><span style=color:#abb2bf>));</span></span>
<span class=line><span style=color:#abb2bf>};</span></span></code></pre><p>由于<code>G(G)</code>是我们的递归函数，于是我们可以定义函数 Y，使得<code>Y(F) == G(G)</code>:</p><pre class="astro-code one-dark-pro" is:raw="" style=background-color:#282c34;overflow-x:auto;white-space:pre-wrap;word-wrap:break-word tabindex=0><code><span class=line><span style=color:#c678dd>var</span><span style=color:#abb2bf> </span><span style=color:#61afef>Y</span><span style=color:#abb2bf> </span><span style=color:#56b6c2>=</span><span style=color:#abb2bf> </span><span style=color:#c678dd>function</span><span style=color:#abb2bf> (</span><span style=color:#e06c75;font-style:italic>F</span><span style=color:#abb2bf>) {</span></span>
<span class=line><span style=color:#abb2bf>  </span><span style=color:#c678dd>var</span><span style=color:#abb2bf> </span><span style=color:#61afef>G</span><span style=color:#abb2bf> </span><span style=color:#56b6c2>=</span><span style=color:#abb2bf> </span><span style=color:#c678dd>function</span><span style=color:#abb2bf> (</span><span style=color:#e06c75;font-style:italic>f</span><span style=color:#abb2bf>) {</span></span>
<span class=line><span style=color:#abb2bf>    </span><span style=color:#c678dd>return</span><span style=color:#abb2bf> </span><span style=color:#61afef>F</span><span style=color:#abb2bf>(</span><span style=color:#61afef>f</span><span style=color:#abb2bf>(</span><span style=color:#e06c75>f</span><span style=color:#abb2bf>));</span></span>
<span class=line><span style=color:#abb2bf>  };</span></span>
<span class=line><span style=color:#abb2bf>  </span><span style=color:#c678dd>return</span><span style=color:#abb2bf> </span><span style=color:#61afef>G</span><span style=color:#abb2bf>(</span><span style=color:#e5c07b>G</span><span style=color:#abb2bf>);</span></span>
<span class=line><span style=color:#abb2bf>};</span></span></code></pre><p>这个<code>Y</code>就是我们的 Y-combinator 了，只要把一个形似<code>F</code>的函数丢给<code>Y</code>，就可以获得一个完美的递归函数了！ 我们已经测试过了<code>G(G)</code>, 让我们再试试<code>Y(F)</code>。咦，不对啊，<code>Maximum call stack size exceeded</code>，难道我们推理有误？</p><p>好吧，这是最后一个坑了。问题出在<code>F(f(f))</code>，实际上我们需要在<code>else</code>分支执行<code>f(f)(n-1)</code>，而由于 JS 是没有<a href=http://en.wikipedia.org/wiki/Lazy_evaluation>Lazy Evaluation</a>的，于是<code>F(f(f))</code>里的<code>f(f)</code>会直接执行。让我们来 fix 这个 bug:</p><pre class="astro-code one-dark-pro" is:raw="" style=background-color:#282c34;overflow-x:auto;white-space:pre-wrap;word-wrap:break-word tabindex=0><code><span class=line><span style=color:#c678dd>var</span><span style=color:#abb2bf> </span><span style=color:#61afef>Y</span><span style=color:#abb2bf> </span><span style=color:#56b6c2>=</span><span style=color:#abb2bf> </span><span style=color:#c678dd>function</span><span style=color:#abb2bf> (</span><span style=color:#e06c75;font-style:italic>F</span><span style=color:#abb2bf>) {</span></span>
<span class=line><span style=color:#abb2bf>  </span><span style=color:#c678dd>var</span><span style=color:#abb2bf> </span><span style=color:#61afef>G</span><span style=color:#abb2bf> </span><span style=color:#56b6c2>=</span><span style=color:#abb2bf> </span><span style=color:#c678dd>function</span><span style=color:#abb2bf> (</span><span style=color:#e06c75;font-style:italic>f</span><span style=color:#abb2bf>) {</span></span>
<span class=line><span style=color:#abb2bf>    </span><span style=color:#c678dd>return</span><span style=color:#abb2bf> </span><span style=color:#61afef>F</span><span style=color:#abb2bf>(</span><span style=color:#c678dd>function</span><span style=color:#abb2bf> (</span><span style=color:#e06c75;font-style:italic>x</span><span style=color:#abb2bf>) {</span></span>
<span class=line><span style=color:#abb2bf>      </span><span style=color:#c678dd>return</span><span style=color:#abb2bf> </span><span style=color:#61afef>f</span><span style=color:#abb2bf>(</span><span style=color:#e06c75>f</span><span style=color:#abb2bf>)(</span><span style=color:#e06c75>x</span><span style=color:#abb2bf>);</span></span>
<span class=line><span style=color:#abb2bf>    });</span></span>
<span class=line><span style=color:#abb2bf>  };</span></span>
<span class=line><span style=color:#abb2bf>  </span><span style=color:#c678dd>return</span><span style=color:#abb2bf> </span><span style=color:#61afef>G</span><span style=color:#abb2bf>(</span><span style=color:#e5c07b>G</span><span style=color:#abb2bf>);</span></span>
<span class=line><span style=color:#abb2bf>};</span></span></code></pre><p>最后，让我们把语法糖去掉，看看完全匿名函数写成的递归函数:</p><pre class="astro-code one-dark-pro" is:raw="" style=background-color:#282c34;overflow-x:auto;white-space:pre-wrap;word-wrap:break-word tabindex=0><code><span class=line><span style=color:#abb2bf>(</span><span style=color:#c678dd>function</span><span style=color:#abb2bf> (</span><span style=color:#e06c75;font-style:italic>F</span><span style=color:#abb2bf>) {</span></span>
<span class=line><span style=color:#abb2bf>  </span><span style=color:#c678dd>return</span><span style=color:#abb2bf> (</span><span style=color:#c678dd>function</span><span style=color:#abb2bf> (</span><span style=color:#e06c75;font-style:italic>G</span><span style=color:#abb2bf>) {</span></span>
<span class=line><span style=color:#abb2bf>    </span><span style=color:#c678dd>return</span><span style=color:#abb2bf> </span><span style=color:#61afef>G</span><span style=color:#abb2bf>(</span><span style=color:#e5c07b>G</span><span style=color:#abb2bf>);</span></span>
<span class=line><span style=color:#abb2bf>  })(</span><span style=color:#c678dd>function</span><span style=color:#abb2bf> (</span><span style=color:#e06c75;font-style:italic>f</span><span style=color:#abb2bf>) {</span></span>
<span class=line><span style=color:#abb2bf>    </span><span style=color:#c678dd>return</span><span style=color:#abb2bf> </span><span style=color:#61afef>F</span><span style=color:#abb2bf>(</span><span style=color:#c678dd>function</span><span style=color:#abb2bf> (</span><span style=color:#e06c75;font-style:italic>x</span><span style=color:#abb2bf>) {</span></span>
<span class=line><span style=color:#abb2bf>      </span><span style=color:#c678dd>return</span><span style=color:#abb2bf> </span><span style=color:#61afef>f</span><span style=color:#abb2bf>(</span><span style=color:#e06c75>f</span><span style=color:#abb2bf>)(</span><span style=color:#e06c75>x</span><span style=color:#abb2bf>);</span></span>
<span class=line><span style=color:#abb2bf>    });</span></span>
<span class=line><span style=color:#abb2bf>  });</span></span>
<span class=line><span style=color:#abb2bf>})(</span><span style=color:#c678dd>function</span><span style=color:#abb2bf> (</span><span style=color:#e06c75;font-style:italic>f</span><span style=color:#abb2bf>) {</span></span>
<span class=line><span style=color:#abb2bf>  </span><span style=color:#c678dd>return</span><span style=color:#abb2bf> </span><span style=color:#c678dd>function</span><span style=color:#abb2bf> (</span><span style=color:#e06c75;font-style:italic>n</span><span style=color:#abb2bf>) {</span></span>
<span class=line><span style=color:#abb2bf>    </span><span style=color:#c678dd>if</span><span style=color:#abb2bf> (</span><span style=color:#e06c75>n</span><span style=color:#abb2bf> </span><span style=color:#56b6c2>==</span><span style=color:#abb2bf> </span><span style=color:#d19a66>1</span><span style=color:#abb2bf>) {</span></span>
<span class=line><span style=color:#abb2bf>      </span><span style=color:#c678dd>return</span><span style=color:#abb2bf> </span><span style=color:#d19a66>1</span><span style=color:#abb2bf>;</span></span>
<span class=line><span style=color:#abb2bf>    } </span><span style=color:#c678dd>else</span><span style=color:#abb2bf> {</span></span>
<span class=line><span style=color:#abb2bf>      </span><span style=color:#c678dd>return</span><span style=color:#abb2bf> </span><span style=color:#e06c75>n</span><span style=color:#abb2bf> </span><span style=color:#56b6c2>*</span><span style=color:#abb2bf> </span><span style=color:#61afef>f</span><span style=color:#abb2bf>(</span><span style=color:#e06c75>n</span><span style=color:#abb2bf> </span><span style=color:#56b6c2>-</span><span style=color:#abb2bf> </span><span style=color:#d19a66>1</span><span style=color:#abb2bf>);</span></span>
<span class=line><span style=color:#abb2bf>    }</span></span>
<span class=line><span style=color:#abb2bf>  };</span></span>
<span class=line><span style=color:#abb2bf>})(</span><span style=color:#d19a66>5</span><span style=color:#abb2bf>); </span><span style=color:#7f848e;font-style:italic>// output 120</span></span></code></pre><p>😆</p><h3 id=interpreter>Interpreter</h3><p><code>The Little Schemer</code>的第十章，主要是讲如何用 scheme 实现一个简单的 scheme 解释器，虽然只支持 built-in 的方法和 lambda，但已然十分强大，其实现过程真正体现了<code>数据即程序</code>的特点。不过这个 code 就真是一大坨了，在此就不张贴了。要看 code 的戳<a href=https://github.com/martin-liu/learning/blob/master/scheme/The_Little_Schemer.scm#L856>这里</a></p><h2 id=commandments>Commandments</h2><p>最后，<code>The Little Schemer</code>里总结了十条诫律，非常有价值，在此罗列如下</p><ol><li>Always ask, null? for atom/lat, zero? for number; when S-expression, ask (null? l), (atom? (car l)) and else.</li><li>cons => use to build list</li><li>When build a list, describe the first typical element, and then cons it onto the natural recursion</li><li>Always change at least one argument while recurring.(否则无法停止). It must be changed to be closer to termination. When lat, use (cdr lat); when number, use (sub1 n); when S-expression, use (car l) and (cdr l) if (null? l) is false and (atom? (car l)) is false</li><li>考虑终止条件，应选择不改变当前 value 的条件: when +, use 0; when *, use 1; when cons, use ()</li><li>Simplify only after the function is correct, 当之前的函数是正确的时候，可以利用相互递归来简化它们。 如<code>eqlist?</code>和<code>equal?</code>互相依赖</li><li>Recur on the subparts that are of the same nature:<ul><li>On the sublists of a list</li><li>On the sub expressions of an arithmetic expression</li></ul></li><li>Use help functions to abstract from representations</li><li><code>Abstract</code> common patterns with a new function.</li><li>Build functions to collect more than one value at a time. 通过包装 function 产生新的 function, 让新的 function 来 collect 本次调用产生的数据</li></ol><h2 id=code>Code</h2><p>所有 code 放在<a href=https://github.com/martin-liu/learning/blob/master/scheme/The_Little_Schemer.scm>这里</a>，如果真有人想看的话 :no_mouth:</p></article><ul class="astro-VJ4TPSPI tags-container"><li class="astro-BLWJYJPT inline-block my-1 underline-offset-4"><a href=/tags/chinese class="astro-BLWJYJPT group pr-2 text-sm"><svg class="astro-BLWJYJPT scale-75" xmlns=http://www.w3.org/2000/svg><path d="M16.018 3.815 15.232 8h-4.966l.716-3.815-1.964-.37L8.232 8H4v2h3.857l-.751 4H3v2h3.731l-.714 3.805 1.965.369L8.766 16h4.966l-.714 3.805 1.965.369.783-4.174H20v-2h-3.859l.751-4H21V8h-3.733l.716-3.815-1.965-.37zM14.106 14H9.141l.751-4h4.966l-.752 4z" class=astro-BLWJYJPT></path></svg> &nbsp;<span class=astro-BLWJYJPT>chinese</span></a></li><li class="astro-BLWJYJPT inline-block my-1 underline-offset-4"><a href=/tags/programming class="astro-BLWJYJPT group pr-2 text-sm"><svg class="astro-BLWJYJPT scale-75" xmlns=http://www.w3.org/2000/svg><path d="M16.018 3.815 15.232 8h-4.966l.716-3.815-1.964-.37L8.232 8H4v2h3.857l-.751 4H3v2h3.731l-.714 3.805 1.965.369L8.766 16h4.966l-.714 3.805 1.965.369.783-4.174H20v-2h-3.859l.751-4H21V8h-3.733l.716-3.815-1.965-.37zM14.106 14H9.141l.751-4h4.966l-.752 4z" class=astro-BLWJYJPT></path></svg> &nbsp;<span class=astro-BLWJYJPT>programming</span></a></li></ul><script src=https://giscus.app/client.js async crossorigin=anonymous data-category=Announcements data-category-id=DIC_kwDOAY2ANs4CWzNL data-emit-metadata=0 data-input-position=bottom data-lang=en data-mapping=title data-reactions-enabled=1 data-repo=martin-liu/martin-liu.github.io data-repo-id="MDEwOlJlcG9zaXRvcnkyNjA1MDYxNA==" data-strict=0 data-theme=light_tritanopia></script></main><footer class="astro-SZ7XMLTE mt-auto"><div class="max-w-3xl mx-auto px-0"><hr aria-hidden=true class=border-skin-line></div><div class="astro-SZ7XMLTE footer-wrapper"><div class="astro-UPU6FZXR flex social-icons"><a href=https://github.com/martin-liu class="inline-block astro-5EUNQZKT group astro-UPU6FZXR link-button" title=" Martin Liu on Github" tabindex=0><svg class=icon-tabler xmlns=http://www.w3.org/2000/svg stroke-linecap=round stroke-linejoin=round><path d="M0 0h24v24H0z" fill=none stroke=none></path><path d="M9 19c-4.3 1.4 -4.3 -2.5 -6 -3m12 5v-3.5c0 -1 .1 -1.4 -.5 -2c2.8 -.3 5.5 -1.4 5.5 -6a4.6 4.6 0 0 0 -1.3 -3.2a4.2 4.2 0 0 0 -.1 -3.2s-1.1 -.3 -3.5 1.3a12.3 12.3 0 0 0 -6.2 0c-2.4 -1.6 -3.5 -1.3 -3.5 -1.3a4.2 4.2 0 0 0 -.1 3.2a4.6 4.6 0 0 0 -1.3 3.2c0 4.6 2.7 5.7 5.5 6c-.6 .6 -.6 1.2 -.5 2v3.5"></path></svg> </a><a href=https://www.linkedin.com/in/hflhmartin/ class="inline-block astro-5EUNQZKT group astro-UPU6FZXR link-button" title="Martin Liu on LinkedIn" tabindex=0><svg class=icon-tabler xmlns=http://www.w3.org/2000/svg stroke-linecap=round stroke-linejoin=round><path d="M0 0h24v24H0z" fill=none stroke=none></path><rect height=16 rx=2 width=16 x=4 y=4></rect><line x1=8 x2=8 y1=11 y2=16></line><line x1=8 x2=8 y1=8 y2=8.01></line><line x1=12 x2=12 y1=16 y2=11></line><path d="M16 16v-3a2 2 0 0 0 -4 0"></path></svg> </a><a href=mailto:hflhmartin@gmail.com class="inline-block astro-5EUNQZKT group astro-UPU6FZXR link-button" title="Send an email to Martin Liu" tabindex=0><svg class=icon-tabler xmlns=http://www.w3.org/2000/svg stroke-linecap=round stroke-linejoin=round><path d="M0 0h24v24H0z" fill=none stroke=none></path><rect height=14 rx=2 width=18 x=3 y=5></rect><polyline points="3 7 12 13 21 7"></polyline></svg></a></div><div class="astro-SZ7XMLTE copyright-wrapper"><span class=astro-SZ7XMLTE>Copyright &#169; 2024</span> <span class="astro-SZ7XMLTE separator">&nbsp;|&nbsp;</span> <span class=astro-SZ7XMLTE>All rights reserved.</span></div></div></footer></body></html>